<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="detail">
	
	<!-- 펜션정보 가져오기 -->
	<select id="select" resultType="map" parameterType="int">
		<![CDATA[
			select  p.no
			        ,p.company_no
			        ,p.name
			        ,p.postal_code
			        ,p.address
			        ,p.detail_address
			        ,p.law_code
			        ,p.law_name
			        ,p.visit_road1
			        ,p.visit_road2
			        ,p.visit_road3
			        ,p.area_info1
			        ,p.area_info2
			        ,p.area_info3
			        ,p.rules
			        ,p.live_pay livePay
			        ,p.parking_info
			        ,p.etc
			        ,p.check_in
			        ,p.check_out
			        ,p.add_adult_price
			        ,p.add_kid_price
			        ,p.add_baby_price
			        ,p.refund_no
			from    pension p
			where   p.no = #{pensionNo}
		]]>
	</select>
	
	<!-- 평점 및 총 리뷰개수 -->
	<select id = "totalReview" resultType="map" parameterType="int">
		<![CDATA[
			select  to_char(avg(re.stars), '0.0') avgStars
			        ,count(re.review_no) rCount
			from    pension p, rooms r, reservations res, reviews re
			where   p.no = r.pension_no
			and     r.no = res.room_no
			and     res.no = re.no
			and     res.status = '이용완료'
			and     p.no = #{pensionNo}
		]]>
	</select>
	
	<!-- 이미지 리스트 -->
	<select id="selectList" resultType="map" parameterType="map">
		<![CDATA[
				select  ort.rn RN
				        ,ort.no
				        ,ort.pension_no
				        ,ort.image_path
				        ,ort.orders
				from    (select  rownum rn
				                 ,ot.no
				                 ,ot.pension_no
				                 ,ot.image_path
				                 ,ot.orders
				         from    (select  p.no
				                          ,p.pension_no
				                          ,p.image_path
				                          ,p.orders
				                  from    pension_image p
				                  order by no asc) ot
				         )ort
				where   ort.rn >= #{startRnum}
				and     ort.rn <= #{endRnum}
				and		pension_no = #{pensionNo}
		]]>
	</select>
	
	<!-- 전체 사진 갯수 구하기 -->
	<select id="selectTotalCnt" resultType="int" parameterType="int">
		<![CDATA[
			select  count(*) count
			from    pension_image
			where	pension_no = #{pensionNo}
		]]>
	</select>
	
	<!-- 편의시설 리스트 -->
	<select id="pAmenList" resultType="map" parameterType="int">
		<![CDATA[
			select  sAmen.no
					,sAmen.name
					,sAmen.ICON_PATH
			from    pension p, p_amenities pAmen, s_amenities sAmen
			where   p.no = pAmen.pension_no
			and     pAmen.s_amenities_no = sAmen.no
			and     p.no = #{pensionNo}
		]]>
	</select>
	
	<!-- 공용시설 리스트 -->
	<select id="pPubList" resultType="map" parameterType="int">
		<![CDATA[
			select  sPub.no
					,sPub.name
					,sPub.ICON_PATH
			from    pension p, p_public pPub, s_public sPub
			where   p.no = pPub.pension_no
			and     pPub.s_public_no = sPub.no
			and     p.no = #{pensionNo}
		]]>
	</select>
	
	
	<!-- 객실 방 번호 리스트 가져오기 -->
	<select id="roomNo" resultType="map" parameterType="int">
		<![CDATA[
			select  res.room_no
			from    reservations res, rooms r, pension p
			where   res.room_no = r.no
			and     r.pension_no = p.no
			and     status = '예약완료'
			or      status = '양도대기'
			and     p.no = #{pensionNo}
			group by res.room_no
			order by res.room_no asc
		]]>
	</select>
	
	<!-- 날짜에 따른 객실정보 가져오기(예약 후, 양도, 예약 전) -->
	<select id="roomList" parameterType="map" resultType="map">
		<![CDATA[
			select  ro.no NO
			        ,ro.pension_no PENSION_NO
			        ,ro.room_name ROOM_NAME
			        ,ro.standard_people STANDARD_PEOPLE
			        ,ro.max_people MAX_PEOPLE
			        ,ro.add_info ADD_INFO
			        ,r.user_no USER_NO
			        ,r.name NAME
			        ,r.check_in CHECK_IN
			        ,r.check_out CHECK_OUT
			        ,r.adult ADULT
			        ,r.kid KID
			        ,r.baby BABY
			        ,to_char(r.total_price, '999,999') TOTAL_PRICE
			        ,nvl(r.status,'null') STATUS
			        ,to_char(r.trans_price, '999,999') TRANS_PRICE
			        ,to_char(p.price, '999,999') PRICE
			        ,w.name WEEK_NAME
			from    rooms ro , (select  no
			                            ,room_no
			                            ,user_no
			                            ,name
			                            ,hp
			                            ,check_in
			                            ,check_out
			                            ,adult
			                            ,kid
			                            ,baby
			                            ,total_price
			                            ,reg_date
			                            ,pay_way
			                            ,pay_status
			                            ,status
			                            ,trans_price
			                            ,p_r_no
			                    from reservations
			                    where check_in = #{datepicker}
			                    and check_out = #{datepicker2}) r ,prices p , week w
			where   ro.no = r.room_no(+)
			and     ro.pension_no = #{pensionNo}
			and     ro.no = p.room_no
			and     p.no = w.price_no
			and     p.sortation =   (select gubun
			                        from peck p, p_peck pp 
			                        where peck_start < #{datepicker}
			                        and peck_end > #{datepicker}
			                        and p.no = pp.peck_no
			                        and pp.pension_no = #{pensionNo})
			and w.name = TO_CHAR(TO_DATE(#{datepicker},'YYYY-MM-DD'), 'DY')
		]]>
	</select>
		
	<!-- 객실 정보 가져오기 -->
	<select id="roomInfoList" parameterType="map" resultType="map">
		<![CDATA[
			select  sAmen.name
			        ,sAmen.ICON_PATH
			        ,r.add_info
			        ,r.no
			        ,r.room_amenities
			from    pension p, p_amenities pAmen, s_amenities sAmen, rooms r
			where   p.no = pAmen.pension_no
			and     pAmen.s_amenities_no = sAmen.no
			and     p.no = r.pension_no
			and     p.no = #{pensionNo}
			and     r.no = #{roomNo}
		]]>
	</select>
		
	<select id="pensionInfo" parameterType="int" resultType="map">
		<![CDATA[
			select  visit_road1
			        ,visit_road2
			        ,visit_road3
			        ,area_info1
			        ,area_info2
			        ,area_info3
			        ,rules
			        ,live_pay
			        ,parking_info
			        ,etc
			        ,check_in
			        ,check_out
			        ,to_char(add_adult_price,'99,999') ADD_ADULT_PRICE
			        ,to_char(add_kid_price,'99,999') ADD_KID_PRICE
			        ,add_baby_price
			        ,refund_no
			from    pension
			where   no = #{pensionNo}
		]]>
	</select>
	
	
	<select id="roomImgList" resultType="map" parameterType="map">
		<![CDATA[
			select  r.pension_no
					,rImg.no rImgNo
					,rImg.rooms_no
					,rImg.image_path
			from    rooms r, room_image rImg
			where   r.no = rImg.rooms_no
			and     r.pension_no = #{pensionNo}
			and		rImg.rooms_no = #{roomNo}
		]]>
	</select>
	
	
</mapper>